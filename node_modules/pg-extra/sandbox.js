const { pool } = require('./util')
const { one, many, withTransaction, query, sql } = require('pg-extra')

exports.findUserByUname = async uname => {
    return one(
        pool,
        sql`
            SELECT *
            FROM users
            WHERE lower(uname) = lower(${uname})
        `
    )
}

exports.transferBalance = async function(from, to, amount) {
    return withTransaction(pool, async client => {
        await query(
            client,
            sql`
                UPDATE accounts SET amount = amount - ${amount} WHERE id = ${from}
            `
        )
        await query(
            client,
            sql`
                UPDATE accounts SET amount = amount + ${amount} WHERE id = ${to}
            `
        )
    })
}
